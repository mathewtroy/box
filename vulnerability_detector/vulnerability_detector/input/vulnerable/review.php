<?php
session_start();

$hostname = 'localhost';
$username = 'root';
$password = '';
$database = 'user-db';

// Create connection
$conn = new mysqli($hostname, $username, $password, $database);

// Check connection
if ($conn->connect_error) {
  die("We apologize. Database is not working.
  We will fix the problem in the near future." .
  $conn->connect_error);
}

if (isset($_POST['delete_comment'])) {
    $comment_id = $_POST['comment_id'];

    // Delete comments from Database
    $delete_sql = "DELETE FROM comments WHERE comment_id = ?";
    $stmt = $conn->prepare($delete_sql);
    $stmt->bind_param("i", $comment_id);
    $stmt->execute();

    header("Location: ../controllers/review.php");
    exit();
}

// $sender ='';
$message = '';
$commentIsSent = isset($_POST['post_comment']);

if ($commentIsSent) {

    // $sender = $_POST['sender'];

    if (isset($_SESSION['admin_name'])) $sender = $_SESSION['admin_name'] ;
    elseif (isset($_SESSION['user_name'])) $sender = $_SESSION['user_name'] ;

    $message = $_POST['message'] ;

    $sql ="INSERT INTO comments (sender, message)
    VALUES ('$sender', '$message')";

    if ($conn->query($sql) === TRUE) {
        header('location:../controllers/review.php');
    }
  

}

?>
<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>review</title>
      <!-- Swiper css link  -->
      <link rel="stylesheet"
      href="https://unpkg.com/swiper@7/swiper-bundle.min.css">

      <!-- Font awesome cdn link  -->
      <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.4.0/css/all.min.css">

      <!-- Custom main css file link  -->
      <link rel="stylesheet" href="/secure/public/css/style.css">

      <!-- Custom footer css file link  -->
      <link rel="stylesheet" href="/secure/public/css/style-footer.css">

      <!-- Media queries  -->
      <link rel="stylesheet" href="/secure/public/css/media.css">

      <!-- Custom js file link  -->
      <script src="/secure/public/js/script.js"></script>
   </head>

    <body>
        <!-- Header section starts -->

        <section class="header">

           <?php if (!isset($_SESSION['user_name']) && !isset($_SESSION['admin_name'])): ?>
              <!-- Logo for unauthorized users -->
              <a href="/secure/public/index.php" class="logo">
                 <img src="/secure/public/images/Vulnerable.svg" alt="Vulnerable">
              </a>
           <?php else: ?>
              <!-- Logo for authorized users -->
              <a href="../models/home.php" class="logo">
                 <img src="/secure/public/images/BoxingIcon.svg" alt="BoxingIcon">
              </a>
           <?php endif; ?>

           <nav class="navbar">
              <a href="../models/home.php">Home</a>
              <a href="../models/about.php">About</a>
              <a href="../controllers/review.php"> Review</a>
              <a href="../controllers/booking.php">Booking</a>

              <!-- Unauthorized users see Login page , Register Page -->
              <?php if (!isset($_SESSION['user_name']) && !isset($_SESSION['admin_name']) ): ?>
                 <a href="../controllers/login.php">Login</a>
                 <a href="../controllers/register.php">Register</a>
              <?php else:?>

              <!-- Authorized users see Log Out page -->
              <a href="../controllers/logout.php">Log out</a>

                 <?php if(isset($_SESSION['admin_name'])): ?>
                    <a href="../models/admin_page.php">Personal account</a>

                 <?php else: ?>
                    <!-- if(isset($_SESSION['user_name'])): -->
                    <a href="../models/user_page.php">Personal account</a>
                 <?php endif; ?>
              <?php endif; ?>
           </nav>

           <div id="menu-btn" class="fas fa-bars"></div>
        </section>

        <!-- Header section ends -->

        <div class="main">
            <div><h1>Review</h1></div>
        </div>

        <section class="review">
        <!-- For non-users -->
        <!--  Unauthorized users see Login page , Register Page -->
        <?php if (!isset($_SESSION['user_name']) && !isset($_SESSION['admin_name']) ): ?>

            <p class="nonuser">If you want to leave a review, 
                log into your account.
            </p>
            <?php else:?>

        <!-- For USERS -->

            <!--  Authorized users see Log Out page -->

            <!-- Import review form from PHP file -->
                <div class="form-container">
                    <form

                    method="POST"
                    action=""
                    id="commentForm" >

                        <!-- Import check Message -->
                        <label for="message">Comment message</label>
                        <p class="inform">Write your comment (English language), min.5, max.200
                            characters</p>
                        <textarea
                            name="message"
                            rows="10"
                            cols="50"
                            minlength="5"
                            maxlength="202"
                            placeholder="Write a comment* (Required)"
                            id="message"></textarea><br>

                        <button type="submit" class="btn"
                            name="post_comment">Post Comment</button>

                    </form>
                </div>

            <?php endif; ?>  
             

        </section>

        <h2 class="comments">Comments of users</h2>

        <?php
            $sql = "SELECT * FROM comments";
            $result = $conn->query($sql);

            if ($result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
            
            ?>
            <h4 class="date-name"><?php echo $row['date'];?> </h4>
            <p class="sender-name"><?php echo 'user: ',$row['sender'];?></p>
            <p class="message-name"><?php echo $row['message'];?></p>

            <div class="delete-button">
                <!-- For Admins "Delete" -->
                <?php if (isset($_SESSION['admin_name'])): ?>
                    <form 
                    method="POST" 
                    action="<?php echo htmlspecialchars($_SERVER['PHP_SELF']) ?>">
                        <input type="hidden" name="comment_id" 
                        value="<?php echo $row['comment_id']; ?>">

                        <button type="submit" name="delete_comment" 
                        id="delete_comment">Delete</button>
                    </form>
                <?php endif; ?>

            </div>

        <?php }} ?> 

        <!-- Footer section starts -->

        <section class="footer">

            <div class="box-container">

                <div class="box">
                    <h3>Main Links</h3>
                    <a href="../models/home.php"> <i class="fas fa-home"></i> Home</a>
                    <a href="../models/about.php"> <i class="fas fa-info-circle"></i> About</a>
                    <a href="../controllers/review.php"> <i class="fas fa-suitcase-rolling"></i> Review</a>
                    <a href="../controllers/booking.php"> <i class="far fa-money-bill-alt"></i> Booking</a>

                    <!--
                    Unauthorized users see Login page , Register Page
                    -->
                    <?php if (!isset($_SESSION['user_name']) && !isset($_SESSION['admin_name']) ): ?>
                    <a href="../controllers/login.php">
                        <i class="fas fa-sign-in-alt"></i> Login</a>
                    <a href="../controllers/register.php">
                        <i class="fas fa-user-plus"></i> Register</a>

                    <?php else:?>

                    <!-- Authorized users see Add review page -->
                    <?php if (isset($_SESSION['user_name']) || isset($_SESSION['admin_name']) ):  ?>
                        <a href="../controllers/logout.php"><i class="fas fa-power-off"></i> Log out</a>

                        <?php if(isset($_SESSION['admin_name'])): ?>

                            <a href="admin_page.php">
                                <i class="far fa-address-card"></i>	Personal account</a>

                        <?php else: ?>

                            <!-- if(isset($_SESSION['user_name'])): -->
                            <a href="user_page.php"><i class="far fa-address-card"></i>	Personal account</a>

                        <?php endif; ?>
                        <?php endif; ?>
                    <?php endif; ?>
                </div>

                <div class="box">
                    <h3>Contact Info</h3>
                    <a href="tel:+420776756746"> <i class="fas fa-phone">
                    </i> Phone Number </a>
                    <a href="mailto:krossale@fel.cvut.cz"> <i class="fas fa-envelope">
                    </i> Email </a>
                    <a href="https://www.github.com/mathewtroy/">
                        <i class="fab fa-github"></i> Github </a>
                    <a href="https://t.me/troy102102/">
                        <i class="fab fa-telegram"></i> Telegram </a>
                    <a href="https://www.linkedin.com/in/aleksandrkross/">
                        <i class="fab fa-linkedin"></i> Linkedin </a>

                </div>

            </div>

            <div class="credit"> Created by
                <span>Aleksandr K.</span>
                <br>
                &copy; 2024. All rights reserved!
            </div>

        </section>

        <!-- Footer section ends -->

    </body>
</html>