# report_generators/injection_report.py

from typing import List, Dict
from datetime import datetime
from collections import defaultdict

class InjectionReportGenerator:
    """
    Generates a report for injection vulnerabilities (e.g., XSS) in PHP files.
    """

    def __init__(self, vulnerabilities: List[Dict], scanned_files: List[str]):
        """
        Initialize the report generator with vulnerabilities and scanned files.

        Args:
            vulnerabilities (List[Dict]): List of detected vulnerabilities.
            scanned_files (List[str]): List of all scanned PHP files.
        """
        self.vulnerabilities = vulnerabilities
        self.scanned_files = scanned_files

    def generate(self) -> str:
        """
        Generate the injection report in the specified format.

        Returns:
            str: Formatted report string.
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        report_lines = [
            "Bachelor's Project - Research on Web Application Vulnerabilities",
            "",
            "Author: Aleksandr Kross",
            "Institution: Faculty of Electrical Engineering, Czech Technical University in Prague",
            "Department: Department of Computer Science",
            "",
            "Static PHP Code Analysis Report - Injection",
            f"Date and Time of Report Generation: {timestamp}",
            "",
            "Report Summary:",
            "This report analyzes PHP files for potential XSS vulnerabilities by identifying unfiltered user input that is output to the page.",
            "",
            "Actions Taken:",
            "PHP files in the 'input/vulnerable/' directory were statically analyzed to identify XSS vulnerabilities where user input is displayed directly on the page without sanitization.",
            "",
            "Vulnerabilities Found:",
            ""
        ]

        if not self.vulnerabilities:
            report_lines.append("No vulnerabilities detected.")
        else:
            # Group vulnerabilities by file
            vuln_by_file = defaultdict(list)
            for vuln in self.vulnerabilities:
                vuln_by_file[vuln['file']].append(vuln)

            for file, vulns in vuln_by_file.items():
                report_lines.append(f"File: {file}")
                for vuln in vulns:
                    report_lines.append(f"Description: {vuln['description']}")
                    report_lines.append("Potential Vulnerable Code Locations:")
                    for location in vuln.get('locations', []):
                        report_lines.append(f" - {location}")
                    report_lines.append(f"Recommendation: {vuln['recommendation']}")
                    report_lines.append("")  # Blank line between vulnerabilities

        report_lines.extend([
            "Result:",
            "Potential XSS vulnerabilities were detected and are detailed above."
        ])

        return "\n".join(report_lines)
