# report_generators/insecure_design_report.py

from typing import List, Dict
from datetime import datetime
from collections import defaultdict

class InsecureDesignReportGenerator:
    """
    Generates a report for insecure design vulnerabilities in PHP files.
    """

    def __init__(self, vulnerabilities: List[Dict], scanned_files: List[str]):
        """
        Initialize the report generator with vulnerabilities and scanned files.

        Args:
            vulnerabilities (List[Dict]): List of detected vulnerabilities.
            scanned_files (List[str]): List of all scanned PHP files.
        """
        self.vulnerabilities = vulnerabilities
        self.scanned_files = scanned_files

    def generate(self) -> str:
        """
        Generate the insecure design report in the specified format.

        Returns:
            str: Formatted report string.
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        report_lines = [
            "Bachelor's Project - Research on Web Application Vulnerabilities",
            "",
            "Author: Aleksandr Kross",
            "Institution: Faculty of Electrical Engineering, Czech Technical University in Prague",
            "Department: Department of Computer Science",
            "",
            "Static PHP Code Analysis Report - Insecure Design",
            f"Date and Time of Report Generation: {timestamp}",
            "",
            "Report Summary:",
            "This report provides an in-depth analysis of potential insecure design vulnerabilities in PHP files.",
            "The goal is to detect missing security mechanisms like brute-force protection and two-factor authentication.",
            "",
            "Scanned Files:"
        ]

        # Remove duplicates and sort the scanned files
        unique_scanned_files = sorted(set(self.scanned_files))
        for file in unique_scanned_files:
            report_lines.append(f" - {file}")

        report_lines.extend([
            "",
            "Detected Vulnerabilities:",
            ""
        ])

        if not self.vulnerabilities:
            report_lines.append("No vulnerabilities detected.")
        else:
            # Group vulnerabilities by file
            vuln_by_file = defaultdict(list)
            for vuln in self.vulnerabilities:
                vuln_by_file[vuln['file']].append(vuln)

            for file, vulns in vuln_by_file.items():
                report_lines.append(f"File: {file}")
                for vuln in vulns:
                    report_lines.append(f"Description: {vuln['description']}")
                    report_lines.append(f"Impact: {vuln['impact']}")
                    report_lines.append(f"Recommendation: {vuln['recommendation']}")
                    report_lines.append("")  # Blank line between vulnerabilities

        return "\n".join(report_lines)
