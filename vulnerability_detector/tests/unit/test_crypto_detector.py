import pytest, textwrap
from detectors.cryptographic_failures_detector import CryptographicFailuresDetector
from config.config import Config


@pytest.fixture
def detector():
    return CryptographicFailuresDetector(Config())


def test_register_without_password_hash(detector):
    """Detects missing password hashing in a registration form."""
    php = textwrap.dedent("""
        <?php
        /* Simple registration form */
        echo '<form><input type="password" name="pass"></form>';

        if (isset($_POST['pass'])) {
            $pass = $_POST['pass'];           // plainâ€‘text storage
            $sql  = "INSERT INTO users (password) VALUES ('$pass')";
        }
    """)
    findings = detector.analyze_php_file(php, "register.php")

    assert findings, "Expected a vulnerability about missing password_hash()"
    assert any("password_hash" in v["recommendation"] for v in findings)


def test_login_with_password_verify(detector):
    """Confirms correct use of password_verify() is not flagged."""
    php = textwrap.dedent("""
        <?php
        $valid = password_verify($pass, $row['password']);
    """)
    findings = detector.analyze_php_file(php, "login.php")

    assert findings == [], "No vulnerability expected for secure code"
