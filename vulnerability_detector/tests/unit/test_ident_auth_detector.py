import textwrap
from detectors.identification_authentication_detector import IdentificationAuthenticationDetector
from config.config import Config


def detector():
    return IdentificationAuthenticationDetector(Config())


def test_login_without_bruteforce_and_2fa():
    """Verifies multiple missing security features in a login page."""
    php = textwrap.dedent("""
        <?php
        // simple login form (no security controls)
        if (isset($_POST['user'])) {
            if ($_POST['pass'] == $row['password']) echo "welcome";
        }
    """)
    vulns = detector().analyze_php_file(php, "login.php")
    descriptions = {v["description"] for v in vulns}

    assert "Missing brute-force protection mechanism." in descriptions
    assert "Missing two-factor authentication." in descriptions
    assert "Plain text or weakly hashed passwords detected." in descriptions


def test_login_with_security_controls():
    """Ensures login with proper protection is considered secure."""
    php = textwrap.dedent("""
        <?php
        if (login_attempts($user) > 3) { lockout($user); }
        two_factor_auth($user);
        $ok = password_verify($pass, $row['password']);
    """)
    assert detector().analyze_php_file(php, "login.php") == []
