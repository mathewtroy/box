import pytest
from detectors.injection_detector import InjectionDetector
from config.config import Config


@pytest.fixture
def detector():
    return InjectionDetector(Config())


def test_detects_xss(detector):
    """Tests if unescaped user input is correctly flagged as XSS."""
    php = '<?php echo $_GET["q"]; ?>'
    findings = detector.analyze_php_file(php, "index.php")

    assert findings, "Expected at least one vulnerability"
    vuln = findings[0]
    assert "unfiltered user input" in vuln["description"].lower()
    assert vuln["locations"], "Locations list must not be empty"


def test_ignores_safe_echo(detector):
    """Confirms that properly escaped input is not flagged."""
    php = '<?php echo htmlspecialchars($_GET["q"]); ?>'
    findings = detector.analyze_php_file(php, "safe.php")

    assert findings == [], "No vulnerability should be reported"
