import textwrap
from detectors.insecure_design_detector import InsecureDesignDetector
from config.config import Config


def detector():
    return InsecureDesignDetector(Config())


def test_insecure_login_file():
    """Detects missing 2FA and brute-force protection in login form."""
    php = textwrap.dedent("""
        <?php
        echo '<input type="password" name="pass">';
        // security features are missing
    """)
    vulns = detector().analyze_php_file(php, "login.php")
    assert len(vulns) == 2
    msgs = {v["description"] for v in vulns}
    assert "Missing brute-force protection mechanism." in msgs
    assert "Missing two-factor authentication." in msgs


def test_non_auth_file_is_ignored():
    """Ensures non-login files are not incorrectly flagged."""
    php = "<?php echo 'static page'; ?>"
    assert detector().analyze_php_file(php, "about.php") == []
